# Set up python 3.10 on rivanna

```bash
module purge
module load singularity
module load anaconda

conda create -y -n py3.10 python=3.10
source activate py3.10

```

# RUN ON RIVANNA

```bash
python3.10 -m venv ~/ENV3
source ~/ENV3/bin/activate
pip install cloudmesh-installer
cloudmesh-installer get sbatch
```

2. Generating experiment configurations

```bash
export EQ_VERSION=may2022
export EQ_VERSION=may2022
git clone https://github.com/laszewsk/mlcommons.git
cd benchmarks/earthquake/${EQ_VERSION}/experiments/rivanna
# cd benchmarks/earthquake/${EQ_VERSION}/experiments/summit
# partition ds6011-sp22-002 

# running under /project
cms sbatch generate rivanna.in.slurm --setup=rivanna-project.yaml --name="project" --noos 
# You can manually inspect the job files in $(pwd)/project/<identifier>
# To verify the output is correct


# partition bii_gpu
#running under /localscratch
cms sbatch generate rivanna.in.slurm --setup=rivanna-localscratch.yaml --name="localscratch" --noos

# Generate the submit scripts
cms sbatch generate submit --name="project.json" > job-project.sh
# Generate the script to run all jobs 
cms sbatch generate submit --name="localscratch.json" > job-localscratch.sh
```

It's strongly advised that you inspect the output of the above to validate that all generated scripts and files are correct.
Most jobs take several hours, so correcting errors by inspecting the output will save time when troubleshooting.

3. Running the experiments

If all the output from above looks correct, you can execute the jobs by running the last two scripts that are generated by cms sbatch generate submit.

```bash
sh job-project.sh
sh job-localscratch.sh
```

This will request all jobs to be run immediately by slurm, and the notebook file will be outputted in the `$(pwd)/project/<experiment_id>` and `$(pwd)/localscratch/<experiment_id>` directory.

You can see the progress of each job by inspecting the `*.out` and `*.err` files located in the `$(pwd)/project/<experiment_id>` and `$(pwd)/localscratch/<experiment_id>`).

A copy of the final notebook is placed in the slurm expeeriments folder with the suffix `*_output.ipynb`, that can be inspected for further details.
